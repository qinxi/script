{"version":1,"rules":[{"whens":[],"thens":[{"@class":".ThenSetValue","useMessageValue":false,"sourceMessageValue":"SourceAddress","sourceIdentifier":"","sourceIdentifierPlacement":"Last","sourceMessageValueType":"Text","sourceMessageValuePath":"","useReplace":false,"regexPattern":"","text":"gzip, deflate","replacementText":"","destinationMessageValueType":"Text","destinationMessageValuePath":"","destinationMessageValue":"HttpRequestHeader","destinationIdentifier":"Accept-Encoding","destinationIdentifierPlacement":"All"}],"enabled":false,"autoRun":true,"name":"duolingo_disable_br"},{"whens":[{"@class":".WhenMatchesText","negate":false,"useOrCondition":false,"identifier":"","identifierPlacement":"Last","sourceText":"","matchText":"https://.*\\.duolingo\\.[^/]+/[0-9]{4}-[0-9]{2}-[0-9]{2}/batch","messageValue":"Url","messageValueType":"Text","messageValuePath":"","matchType":"Regex","ignoreCase":false,"useMessageValue":true}],"thens":[{"@class":".ThenSetEncoding","encoding":"UTF-8"},{"@class":".ThenSetValue","useMessageValue":false,"sourceMessageValue":"SourceAddress","sourceIdentifier":"","sourceIdentifierPlacement":"Last","sourceMessageValueType":"Text","sourceMessageValuePath":"","useReplace":false,"regexPattern":"","text":"gzip, deflate","replacementText":"","destinationMessageValueType":"Text","destinationMessageValuePath":"","destinationMessageValue":"HttpRequestHeader","destinationIdentifier":"Accept-Encoding","destinationIdentifierPlacement":"All"},{"@class":".ThenRunScript","script":"/**\n * Duolingo \u8BA2\u9605\u72B6\u6001\u4F2A\u88C5 - Burp Reshaper \u811A\u672C\n * \n * \u529F\u80FD: \u4FEE\u6539 Duolingo API \u54CD\u5E94\uFF0C\u5C06\u514D\u8D39\u7528\u6237\u4F2A\u88C5\u4E3A\u8BA2\u9605\u7528\u6237\n * \n * \u4F7F\u7528\u65B9\u6CD5:\n * 1. \u5728 Burp Suite \u4E2D\u5B89\u88C5 Reshaper \u63D2\u4EF6\n * 2. \u521B\u5EFA\u65B0\u89C4\u5219 (HTTP Rules)\n * 3. \u6DFB\u52A0 \"When\" \u6761\u4EF6: \n *    - Type: URL\n *    - Match Type: Contains\n *    - Value: /2023-05-23/batch\n * 4. \u6DFB\u52A0 \"Then\" \u52A8\u4F5C: \n *    - Type: Run Script\n *    - \u7C98\u8D34\u6B64\u811A\u672C\n * 5. \u786E\u4FDD\u89C4\u5219\u5E94\u7528\u4E8E Response (\u53EF\u5728 Rule \u8BBE\u7F6E\u4E2D\u6307\u5B9A)\n * \n * \u53C2\u8003\u6587\u6863: \n * - https://synfron.github.io/ReshaperForBurp/ScriptingLibrary.html\n * - https://synfron.github.io/ReshaperForBurp/MessageValues.html\n */\n\n// \u4F7F\u7528 Reshaper API \u83B7\u53D6\u54CD\u5E94\u4F53\n// Reshaper.event.getMessageValue(messageValueKey, messageValueIdentifier)\nvar responseBody = Reshaper.event.getMessageValue(\"HttpResponseBody\", \"\");\n\n// \u68C0\u67E5\u662F\u5426\u662F JSON \u54CD\u5E94\nif (responseBody && responseBody.indexOf(\"{\") !== -1) {\n    try {\n        var jsonData = JSON.parse(responseBody);\n        var modified = false;\n        \n        // \u5904\u7406 batch \u54CD\u5E94\u4E2D\u7684\u6BCF\u4E2A response\n        if (jsonData.responses && Array.isArray(jsonData.responses)) {\n            for (var i = 0; i < jsonData.responses.length; i++) {\n                var resp = jsonData.responses[i];\n                \n                if (resp.body && typeof resp.body === \"string\") {\n                    try {\n                        var bodyData = JSON.parse(resp.body);\n                        \n                        // \u68C0\u67E5\u662F\u5426\u662F\u7528\u6237\u6570\u636E\u54CD\u5E94 (\u5305\u542B subscriberLevel \u6216 id + learningLanguage)\n                        if (bodyData.subscriberLevel !== undefined || \n                            (bodyData.id && bodyData.learningLanguage)) {\n                            \n                            // 1. \u4FEE\u6539 subscriberLevel: FREE -> PREMIUM\n                            //if (bodyData.subscriberLevel === \"FREE\") {\n                                bodyData.subscriberLevel = \"GOLD\";\n                                bodyData.hasPlus = true;\n                                modified = true;\n                                Reshaper.event.runThen(\"Log\", { text: \"[Duolingo] Modified subscriberLevel: FREE -> PREMIUM\" });\n                            //}\n                            \n                            // 2. \u6DFB\u52A0\u8BA2\u9605\u914D\u7F6E (\u5982\u679C\u4E3A\u7A7A)\n                            //if (!bodyData.subscriptionConfigs || bodyData.subscriptionConfigs.length === 0) {\n                                // \u8BA1\u7B97\u672A\u67657\u5929\u7684\u8FC7\u671F\u65F6\u95F4 (\u6BEB\u79D2)\n                                var futureExpiration = Date.now() + (60 * 24 * 60 * 60 * 1000);\n                                \n                                bodyData.subscriptionConfigs = [{\n                                    \"vendorPurchaseId\": \"mock_purchase_\" + Date.now(),\n                                    \"isInBillingRetryPeriod\": false,\n                                    \"isInGracePeriod\": false,\n                                    \"pauseStart\": null,\n                                    \"pauseEnd\": null,\n                                    \"productId\": \"com.duolingo.DuolingoMobile.subscription.Gold.TwelveMonth.25Q3IncMS87D.Trial7.240\",\n                                    \"receiptSource\": 1,\n                                    \"expirationTimestamp\": futureExpiration,\n                                    \"isFreeTrialPeriod\": false,\n                                    \"itemType\": \"gold_subscription\"\n                                }];\n                                modified = true;\n                                Reshaper.event.runThen(\"Log\", { text: \"[Duolingo] Added subscriptionConfigs\" });\n                            //}\n                            \n                            // 3. \u6E05\u7A7A\u5E7F\u544A\u914D\u7F6E\n                            if (bodyData.adsConfig && bodyData.adsConfig.units && \n                                Object.keys(bodyData.adsConfig.units).length > 0) {\n                                bodyData.adsConfig.units = {};\n                                modified = true;\n                                Reshaper.event.runThen(\"Log\", { text: \"[Duolingo] Cleared adsConfig.units\" });\n                            }\n                            \n                            // 4. \u4FEE\u6539 trackingProperties\n                            //if (bodyData.trackingProperties) {\n                                \n                                bodyData.trackingProperties.has_item_gold_subscription = true;\n                                modified = true;\n                                \n                                \n                                if (bodyData.trackingProperties.monetizable_status === \"free_trial_eligible\") {\n                                    bodyData.trackingProperties.monetizable_status = \"free_trial_owner_super\";\n                                    modified = true;\n                                }\n                            //}\n                            \n                            // 5. \u6DFB\u52A0 premium_subscription \u5230 shopItems (\u5982\u679C\u4E0D\u5B58\u5728)\n                            //if (bodyData.shopItems && Array.isArray(bodyData.shopItems)) {\n                                var hasPremium = false;\n                                for (var j = 0; j < bodyData.shopItems.length; j++) {\n                                    if (bodyData.shopItems[j].id === \"gold_subscription\" || \n                                        bodyData.shopItems[j].itemName === \"gold_subscription\") {\n                                        hasPremium = true;\n                                        break;\n                                    }\n                                }\n                                \n                                if (!hasPremium) {\n                                    var futureExp = Date.now() + (60 * 24 * 60 * 60 * 1000);\n                                    var futureExpSec = Math.floor(futureExp / 1000);\n                                    \n                                    bodyData.shopItems.push({\n                                        \"purchaseId\": \"mock_premium_\" + Date.now(),\n                                        \"purchaseDate\": Math.floor(Date.now() / 1000),\n                                        \"purchasePrice\": 0,\n                                        \"id\": \"gold_subscription\",\n                                        \"itemName\": \"gold_subscription\",\n                                        \"subscriptionInfo\": {\n                                            \"currency\": \"USD\",\n                                            \"expectedExpiration\": futureExpSec,\n                                            \"isFreeTrialPeriod\": false,\n                                            \"isIntroOfferPeriod\": false,\n                                            \"isInBillingRetryPeriod\": false,\n                                            \"periodLength\": 12,\n                                            \"price\": 0,\n                                            \"productId\": \"com.duolingo.DuolingoMobile.subscription.Gold.TwelveMonth.25Q3IncMS87D.Trial7.240\",\n                                            \"renewer\": \"APPLE\",\n                                            \"renewing\": false,\n                                            \"tier\": \"twelve_month\",\n                                            \"type\": \"gold\",\n                                            \"vendorPurchaseId\": \"mock_vendor_\" + Date.now(),\n                                            \"promotionalOfferId\": \"\",\n                                            \"firstPaymentDate\": 0\n                                        },\n                                        \"familyPlanInfo\": {\n                                            \"ownerId\": bodyData.id || 0,\n                                            \"secondaryMembers\": [],\n                                            \"inviteToken\": \"\",\n                                            \"pendingInvites\": [],\n                                            \"pendingInviteSuggestions\": []\n                                        }\n                                    });\n                                    modified = true;\n                                }\n                            //}\n                        }\n                        \n                        // \u66F4\u65B0 body\n                        if (modified) {\n                            resp.body = JSON.stringify(bodyData);\n                        }\n                        \n                    } catch (e) {\n                        // body \u4E0D\u662F\u6709\u6548 JSON\uFF0C\u8DF3\u8FC7\n                    }\n                }\n            }\n        }\n        \n        // \u5982\u679C\u6709\u4FEE\u6539\uFF0C\u66F4\u65B0\u54CD\u5E94\u4F53\n        if (modified) {\n            var newResponseBody = JSON.stringify(jsonData);\n            // \u4F7F\u7528 Reshaper API \u8BBE\u7F6E\u54CD\u5E94\u4F53\n            Reshaper.event.setMessageValue(\"HttpResponseBody\", \"\", newResponseBody);\n            Reshaper.event.runThen(\"Log\", { text: \"[Duolingo] Response body updated successfully!\" });\n        }\n        \n    } catch (e) {\n        Reshaper.event.runThen(\"Log\", { text: \"[Duolingo] Error: \" + e.message });\n    }\n}\n","maxExecutionSeconds":10}],"enabled":false,"autoRun":true,"name":"Duolingo Batch - Modify Response"}],"webSocketRules":[],"variables":[]}